<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verbale di Cantiere</title>
    <style>
        :root {
            --color-bg-primary: #fcfcf9;
            --color-surface: #fffffd;
            --color-text-primary: #13343b;
            --color-text-secondary: #626c71;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-error: #c0152f;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg-primary: #1f2121;
                --color-surface: #262828;
                --color-text-primary: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-border: rgba(119, 124, 124, 0.3);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--color-surface);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--color-primary);
            margin-bottom: 30px;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-text-primary);
            font-size: 14px;
        }

        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--color-surface);
            color: var(--color-text-primary);
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .persona-item {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(var(--color-primary), 0.05);
            border-radius: 8px;
        }

        .persona-item input {
            flex: 1;
        }

        .persona-item .signature-container {
            flex: 1;
        }

        .btn-remove {
            background: var(--color-error);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .btn-remove:hover {
            opacity: 0.9;
        }

        .btn-add {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .btn-add:hover {
            background: var(--color-primary-hover);
        }

        .signature-pad {
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: crosshair;
            background: white;
            touch-action: none;
            display: block;
            width: 100%;
        }

        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .btn-clear-signature {
            background: var(--color-text-secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-clear-signature:hover {
            opacity: 0.8;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--color-error);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-camera {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-camera:hover {
            background: var(--color-primary-hover);
        }

        #cameraInput {
            display: none;
        }

        .btn-export {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            width: 100%;
            margin-top: 30px;
            transition: background 0.3s;
        }

        .btn-export:hover {
            background: var(--color-primary-hover);
        }

        .hidden {
            display: none;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            .btn-add, .btn-remove, .btn-clear-signature, 
            .btn-camera, .btn-export, .btn-remove-photo {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Verbale di Cantiere</h1>
        
        <div class="form-group">
            <label for="nomeCantiere">Nome Cantiere</label>
            <input type="text" id="nomeCantiere" placeholder="Inserisci il nome del cantiere">
        </div>

        <div class="form-group">
            <label for="indirizzo">Indirizzo</label>
            <input type="text" id="indirizzo" placeholder="Inserisci l'indirizzo del cantiere">
        </div>

        <div class="form-group">
            <label for="data">Data</label>
            <input type="date" id="data">
        </div>

        <div class="form-group">
            <label>Persone Coinvolte</label>
            <div id="personeContainer"></div>
            <button class="btn-add" onclick="aggiungiPersona()">+ Aggiungi Persona</button>
        </div>

        <div class="form-group">
            <label for="descrizione">Descrizione Lavori</label>
            <textarea id="descrizione" placeholder="Descrivi i lavori eseguiti o da eseguire"></textarea>
        </div>

        <div class="form-group">
            <label>Fotografie</label>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
            <button class="btn-camera" onclick="document.getElementById('cameraInput').click()">
                ðŸ“· Scatta/Carica Foto
            </button>
            <div id="photoGrid" class="photo-grid"></div>
        </div>

        <button class="btn-export" onclick="esportaPDF()">Esporta PDF</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        let personaCounter = 0;
        let photos = [];
        let signatures = {};

        // Imposta data odierna
        document.getElementById('data').valueAsDate = new Date();

        // Aggiungi prima persona all'avvio
        aggiungiPersona();

        function aggiungiPersona() {
            personaCounter++;
            const container = document.getElementById('personeContainer');
            
            const personaDiv = document.createElement('div');
            personaDiv.className = 'persona-item';
            personaDiv.id = `persona-${personaCounter}`;
            
            personaDiv.innerHTML = `
                <div style="flex: 1;">
                    <input type="text" 
                           id="nome-${personaCounter}" 
                           placeholder="Nome e Cognome"
                           style="margin-bottom: 10px;">
                    <div class="signature-container">
                        <canvas class="signature-pad" 
                                id="signature-${personaCounter}" 
                                width="300" 
                                height="120"></canvas>
                        <div class="signature-controls">
                            <button class="btn-clear-signature" 
                                    onclick="cancellaFirma(${personaCounter})">
                                Cancella Firma
                            </button>
                        </div>
                    </div>
                </div>
                <button class="btn-remove" onclick="rimuoviPersona(${personaCounter})">
                    Rimuovi
                </button>
            `;
            
            container.appendChild(personaDiv);
            inizializzaFirma(personaCounter);
        }

        function inizializzaFirma(id) {
            const canvas = document.getElementById(`signature-${id}`);
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            signatures[id] = { canvas: canvas, hasSignature: false };

            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                lastX = x;
                lastY = y;
                signatures[id].hasSignature = true;
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();

                lastX = x;
                lastY = y;
            }

            function stopDrawing() {
                isDrawing = false;
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function cancellaFirma(id) {
            const canvas = document.getElementById(`signature-${id}`);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatures[id].hasSignature = false;
        }

        function rimuoviPersona(id) {
            const elemento = document.getElementById(`persona-${id}`);
            if (elemento) {
                elemento.remove();
                delete signatures[id];
            }
        }

        document.getElementById('cameraInput').addEventListener('change', function(e) {
            const files = e.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    photos.push(event.target.result);
                    visualizzaFoto();
                };
                reader.readAsDataURL(file);
            }
        });

        function visualizzaFoto() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            
            photos.forEach((photo, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-item';
                photoDiv.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="btn-remove-photo" onclick="rimuoviFoto(${index})">Ã—</button>
                `;
                grid.appendChild(photoDiv);
            });
        }

        function rimuoviFoto(index) {
            photos.splice(index, 1);
            visualizzaFoto();
        }

        async function esportaPDF() {
            const nomeCantiere = document.getElementById('nomeCantiere').value || 'Verbale';
            const indirizzo = document.getElementById('indirizzo').value || '';
            const data = document.getElementById('data').value || '';
            const descrizione = document.getElementById('descrizione').value || '';

            // Mostra messaggio di elaborazione
            const btnExport = document.querySelector('.btn-export');
            const originalText = btnExport.textContent;
            btnExport.textContent = 'Generazione PDF in corso...';
            btnExport.disabled = true;

            try {
                // Crea elemento temporaneo per il PDF
                const pdfContainer = document.createElement('div');
                pdfContainer.style.position = 'absolute';
                pdfContainer.style.left = '-9999px';
                pdfContainer.style.width = '210mm';
                pdfContainer.style.padding = '20mm';
                pdfContainer.style.backgroundColor = 'white';
                pdfContainer.style.fontFamily = 'Arial, sans-serif';
                document.body.appendChild(pdfContainer);

                // Intestazione
                let htmlContent = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: #21808d; font-size: 24px; margin: 0 0 10px 0; border-bottom: 3px solid #21808d; padding-bottom: 10px;">
                            VERBALE DI CANTIERE
                        </h1>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <p style="margin: 8px 0; font-size: 14px;"><strong>Nome Cantiere:</strong> ${nomeCantiere}</p>
                        <p style="margin: 8px 0; font-size: 14px;"><strong>Indirizzo:</strong> ${indirizzo}</p>
                        <p style="margin: 8px 0; font-size: 14px;"><strong>Data:</strong> ${data}</p>
                    </div>
                `;

                // Persone coinvolte
                const personeContainer = document.getElementById('personeContainer');
                const personeItems = personeContainer.querySelectorAll('.persona-item');
                
                if (personeItems.length > 0) {
                    htmlContent += '<div style="margin-bottom: 25px;"><h2 style="color: #21808d; font-size: 18px; margin-bottom: 15px;">Persone Coinvolte</h2>';
                    
                    for (let item of personeItems) {
                        const id = item.id.split('-')[1];
                        const nomeInput = document.getElementById(`nome-${id}`);
                        const nome = nomeInput ? nomeInput.value : '';
                        
                        if (nome) {
                            htmlContent += `<div style="margin-bottom: 15px;"><p style="margin: 5px 0; font-weight: 600; font-size: 14px;">${nome}</p>`;
                            
                            if (signatures[id] && signatures[id].hasSignature) {
                                const signatureData = signatures[id].canvas.toDataURL('image/png');
                                htmlContent += `<img src="${signatureData}" style="max-width: 250px; height: auto; border: 1px solid #ddd; margin-top: 5px;">`;
                            }
                            
                            htmlContent += '</div>';
                        }
                    }
                    htmlContent += '</div>';
                }

                // Descrizione lavori
                if (descrizione) {
                    htmlContent += `
                        <div style="margin-bottom: 25px;">
                            <h2 style="color: #21808d; font-size: 18px; margin-bottom: 15px;">Descrizione Lavori</h2>
                            <p style="line-height: 1.6; text-align: justify; font-size: 13px;">${descrizione.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }

                pdfContainer.innerHTML = htmlContent;

                // Genera PDF con jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                await html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                });

                // Aggiungi foto su pagine separate
                if (photos.length > 0) {
                    pdf.addPage();
                    pdf.setFontSize(18);
                    pdf.setTextColor(33, 128, 141);
                    pdf.text('Fotografie', 105, 20, { align: 'center' });
                    
                    let yPos = 40;
                    for (let i = 0; i < photos.length; i++) {
                        if (i > 0 && i % 2 === 0) {
                            pdf.addPage();
                            yPos = 20;
                        }
                        
                        const img = new Image();
                        img.src = photos[i];
                        
                        await new Promise((resolve) => {
                            img.onload = () => {
                                const imgWidth = 90;
                                const imgHeight = (img.height * imgWidth) / img.width;
                                const xPos = i % 2 === 0 ? 10 : 110;
                                
                                pdf.addImage(photos[i], 'JPEG', xPos, yPos, imgWidth, imgHeight);
                                pdf.setFontSize(10);
                                pdf.setTextColor(100, 100, 100);
                                pdf.text(`Foto ${i + 1}`, xPos + imgWidth / 2, yPos + imgHeight + 5, { align: 'center' });
                                
                                if (i % 2 === 1) {
                                    yPos += imgHeight + 15;
                                }
                                resolve();
                            };
                        });
                    }
                }

                // Salva PDF
                const filename = `Verbale_${nomeCantiere.replace(/\s+/g, '_')}_${data}.pdf`;
                pdf.save(filename);

                // Rimuovi elemento temporaneo
                document.body.removeChild(pdfContainer);

                // Ripristina pulsante
                btnExport.textContent = originalText;
                btnExport.disabled = false;

            } catch (error) {
                console.error('Errore generazione PDF:', error);
                alert('Errore durante la generazione del PDF. Verifica di aver compilato i campi obbligatori.');
                btnExport.textContent = originalText;
                btnExport.disabled = false;
            }
        }
    </script>
</body>
</html>

